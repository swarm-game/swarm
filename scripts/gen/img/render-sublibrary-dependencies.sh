#!/bin/bash -ex

cd $(git rev-parse --show-toplevel)

# First, install cabal-plan:
#
#   cabal install cabal-plan

# If the swarm.cabal file has changed, you may need to remove
# the 'plan.json' file from the cache and regenerate.
#
# Note that "rm -f dist-newstyle/cache/plan.json" is insufficient;
# we need remove the whole cache:
rm -r dist-newstyle/cache
cabal build --dry-run

# Use cabal-plan to generate a graph of sublibrary dependencies.
#   The --tred flag indicates to use transitive reduction, i.e.
#   remove edges A -> C when there are edges A -> B -> C
cabal-plan --hide-global --hide-builtin dot --tred --root swarm |

    # The vertices generated by cabal-plan have names like
    # 'swarm-0.5.0.0:lib:swarm-tui'; this sed command strips off
    # the first two parts from each name leaving only e.g. 'swarm-tui'
    sed 's/"swarm-[^:]*:\(lib\|exe\):/"/g' |

    # The graph output by cabal-plan has "rankdir=LR" which lays
    # out the layers from left to right; we prefer them to be laid out
    # bottom to top.
    sed 's/LR/BT/' |

    # Finally, use dot to render the generated graph to an SVG.
    dot -Tsvg -o docs/image/sublibrary-graph.svg
